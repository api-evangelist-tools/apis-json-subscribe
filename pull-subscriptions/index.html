---
layout: page
title: Pull Subscriptions
---

<script type="text/javascript">

    if(getUrlVar('token'))
      {
        var $oAuth_Token = getUrlVar('token');
      }

    var $org = 'api-evangelist-tools';
    var $repo = 'apis-json-subscribe';

    var $masterFeed = [];

    $apis_json_url = 'http://apis.json.subscribe.apievangelist.com/apis.json';

    var pullMaster = $.get($apis_json_url, function ($apisjson) {

      $subscription_name = $apisjson['name'];
      $subscription_description = $apisjson['description'];
      $subscription_include = $apisjson['include'];

      //console.log($subscription_name);

      $.each($subscription_include, function($key,$value) {
        //console.log($value);
        $entry_name = $value['name'];
        $entry_url = $value['url'];

        console.log("Entry: " + $entry_name);

        var $folder_name = $entry_name.split(' ').join('_');
        var $folder_name = $folder_name.toLowerCase();
        var $apis_json_path = $folder_name + '/apis.json';

        var pullSub = $.get($entry_url, function ($apisjson2) {

          //console.log($oAuth_Token);
          var github = new Github({token: $oAuth_Token,auth: "oauth"});
          var repo = github.getRepo($org,$repo);

          repo.getTree('master?recursive=true', function(err, tree) {

            $treeLength = tree.length;
            $treeCount = 1;
            $createfolder = 1;
            $pullapis = 0;
            $.each(tree, function(treeKey, treeValue) {

              $path = treeValue['path'];
              $sha = treeValue['sha'];

              if($apis_json_path == $path){ $createfolder = 0; }

              if($createfolder == 1 && $treeCount == $treeLength)
                {
                var options = {
                  author: {name: 'Kin Lane', email: 'kinlane@gmail.com'},
                  committer: {name: 'Kin Lane', email: 'kinlane@gmail.com'},
                  encode: true
                }
                $apisjson2_content = JSON.stringify($apisjson2, null, 4);
                repo.write('master',$apis_json_path,$apisjson2_content, 'Subscription Pull', options, function(err) {});
                $createfolder = 1;
                $pullapis = 1;
                }
              else if($createfolder == 0 && $treeCount == $treeLength)
                {
                d = new Date();
                $date_folder = (d.getMonth() + 1) + '-' + d.getDate() + '-' +  d.getFullYear();
                $folder_name = $folder_name + '/' + $date_folder;
                $apis_json_path = $folder_name + '/apis.json';
                $apisjson2_content = JSON.stringify($apisjson2, null, 4);
                repo.write('master',$apis_json_path,$apisjson2_content, 'Subscription Pull', options, function(err) {});
                $createfolder = 1;
                $pullapis = 1;
                }

                if($pullapis == 1)
                  {
                  $.each($apisjson2['apis'], function($apiKey,$apiValue) {

                      $.each($apiValue['properties'], function($apiPropertyKey,$apiPropertyValue) {

                          if($apiPropertyValue['type']=='x-openapi-spec-json')
                            {
                            $fileArray = $apiPropertyValue['url'].split('/');
                            $file_path = $fileArray[$fileArray.length-1];
                            $write_spec_path = $folder_name + "/" + $file_path;

                            //console.log($type);
                            //console.log($url);
                            console.log("1) " + $write_spec_path);
                            //console.log($file_path);

                            //console.log("pulling: " + $apiPropertyValue['url']);

                            var pullIndividualSpec = $.get($apiPropertyValue['url'], function ($openapispec) {
                              console.log("2) " + $write_spec_path);
                              var options = {
                                author: {name: 'Kin Lane', email: 'kinlane@gmail.com'},
                                committer: {name: 'Kin Lane', email: 'kinlane@gmail.com'},
                                encode: true
                              }
//                              repo.write('master',$write_spec_path,JSON.stringify($openapispec, null, 4), 'Subscription Pull', options, function(err) {});
                              })
                              .done(function($openapispec) {
                                  console.log("SUCESS");
                                  console.log($openapispec);
                                })
                              .fail(function() {
                                console.log("NO GO AT ALL!");
                              });

                            }

                        });

                    });
                  }
                $treeCount++;
              });
            });



          });

        });

      });

</script>

<h3>Pull Feeds</h3>
<p>This pulls the feeds from any urls listed in the <a href="">_data/feed-urls.json</a> file, which contains all the target RSS locations we are looking to aggregate.</p>
<ul id="process-feeds"></ul>
